# 线程和进程

## 死锁的概念、条件、避免

- ### 死锁的定义：    

  ​    一组进程中，每个进程都无限等待被该组进程中另一进程所占有的且永远无法释放的资源，这种现象称为进程死锁，这一组进程就称为死锁进程。

- ### 死锁条件

  -  互斥条件

  -  请求和保持条件

  -  不剥夺条件

  -  循环等待条件

    

    1.互斥：进程要求对所分配的资源进行互斥性访问。即在一段时间内某资源仅为一个进程所占有，如果此时还有其它进程要求访问该资源，则要求者只能被阻塞，直到该资源的占用进程用毕释放； 
     2.请求和保持：当进程已经占有了至少一个资源，若又提出了新的资源请求，而该资源又被其它进程所占用，则此请求被阻塞，但对它对已获得的资源保持不放；       
    3.不剥夺：进程已获得的资源，在未使用完之前，不能被剥夺，只能由使用者在使用完后释放；
    4.循环等待：在发生死锁时，必然存在一个进程—资源的环形链。即进程集合{P1、P2、…、Pn}中的P1正在等待一个P2占用的资源，P2正在等待一个P3占用的资源，……、Pn正在等待一个P1占用的资源。
            这四个必要条件中只要有一个条件不满足，都不会形成“死锁”。  

- ### 解决死锁的方法

  -  预防死锁

     - 破坏请求和保持条件（必须满足全部需求才拿资源或者没资源的时候才能申请资源）
     - 破坏不可剥夺  可以剥夺资源，或者 在满足不了 进程需要资源时，释放这个进程已有资源资源
     - 破坏循环等待 按序分配资源

  -  避免死锁

     - 银行家算法

  -  检测与解除死锁

     - 检测：资源分配图 coffman 算法  （检测时机： 请求资源 定时检测）
     - 解除死锁 ：
       - 撤销进程（一次撤销所有死锁进程，或者一个一个撤销，直到死锁解锁） ；、
       - 抢占资源（破坏不可剥夺条件）



## 进程通信方式

- 管道（相当于文件，放在内存或者磁盘，一边只能读，一边只能写，FIFO）有名管道、匿名管道、无名管道。
- 消息队列（存放在内核空间，可以随机访问）
- 共享内存
- Socket 通信
- 信号量通信（**semaphore**用于同步）
- 信号signal

## 进程同步方式

- 读写锁

- 互斥锁（mutex 只能锁 只有一个）

- 信号量（多个线程访问同一个资源，线程个数有上限）

- 条件变量（避免条件不满足的时候 thread2 一直重复 加锁 判断 解锁）https://www.jianshu.com/p/01ad36b91d39

## I/O多路复用

http://kunxiang.wang/2018/03/07/%E4%B8%89%E7%A7%8D%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8IO%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%EF%BC%9Aselect%EF%BC%8Cpoll%EF%BC%8Cepoll/ 

多路是指多个文件描述符FD，复用是指复用同一个线程。三种实现：selet、poll、epoll

### select

轮询各个fd

#### select 优缺点：

优点：
（1）可移植性好
（2）超时值高精度

缺点：
（1）监视FD有限
（2）存放fd的数据结构很大。用户空间和内核空间在传递该结构时复制开销大。
（3）采用轮询，随着fd的增加会造成遍历速度慢的问题。

### poll

在select基础上使用链表存储

#### poll优缺点：

优点：
（1）没有最大连接数的限制，基于链表存储的。
（2）应付大数量的文件描述符时比select要快。

缺点：
（1）大量的fd数组被整体复制于内核态和用户态之间，而不管这样的复制是不是有意义。
（2）同select相同的是调用结束后需要轮询来获取就绪描述符。

### epoll

使用事件进行通知，fd就绪时会调用callback。因此不用轮询。

#### epoll优缺点：

​		优点：

1. 没有最大并发连接的限制

2. 效率提升。不是轮询的方式，使用回调函数的方式。活跃的FD会调用callback

3. epoll使用mmap减少复制开销

   缺点：

   在连接数少并且连接都十分活跃的情况下，select和poll的性能可能比epoll好